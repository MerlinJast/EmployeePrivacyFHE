<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Survey System - Anonymous Corporate Research Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .btn {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading {
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .status {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 10px;
            font-weight: bold;
        }

        .disconnected { 
            background: #6c757d; 
            color: white; 
        }

        .connected { 
            background: #28a745; 
            color: white; 
            animation: pulse 2s infinite;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section.hidden {
            display: none;
        }

        .section h2 {
            font-size: 2rem;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-control:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .project-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .project-description {
            opacity: 0.9;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(45deg, #10b981, #34d399);
            height: 100%;
            transition: width 0.5s;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .donation-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }

        .donation-input {
            flex: 1;
        }

        .quick-amounts {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .quick-amount {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .quick-amount:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .alerts {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 350px;
            max-width: 90vw;
        }

        .alert {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .alert-success { border-left: 4px solid #10b981; }
        .alert-error { border-left: 4px solid #ef4444; }
        .alert-warning { border-left: 4px solid #f59e0b; }
        .alert-info { border-left: 4px solid #3b82f6; }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .owner-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .completed-badge {
            background: linear-gradient(45deg, #10b981, #34d399);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Rating buttons */
        .rating-btn {
            transition: all 0.3s !important;
        }
        
        input[type="radio"]:checked + .rating-btn {
            background: linear-gradient(45deg, #10b981, #34d399) !important;
            border-color: #34d399 !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .rating-btn:hover {
            background: rgba(255,255,255,0.2) !important;
            transform: translateY(-1px);
            cursor: pointer;
        }
        
        .rating-btn:active {
            transform: translateY(0px);
        }
        
        .survey-section {
            border: 2px solid rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .survey-section:hover {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.02);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .donation-form { flex-direction: column; }
            .nav { flex-direction: column; align-items: center; }
            .container { padding: 15px; }
            .section { padding: 20px; }
            .project-stats { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Employee Satisfaction Survey</h1>
            <p>Anonymous Corporate Survey System - Privacy-Protected Research Platform</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                Contract: <a href="https://sepolia.etherscan.io/address/0x32db9e03494b45a0b2b2B85Cfb767CD65B49275A" 
                target="_blank" style="color: #34d399; text-decoration: none;">
                0x9Fdc...1F31</a> | Sepolia Testnet
            </p>
            <div id="contract-status" style="font-size: 0.85rem; margin-top: 10px; padding: 8px 15px; border-radius: 20px; display: inline-block; background: rgba(255,255,255,0.1);">
                🔍 Checking contract status...
            </div>
        </div>

        <div class="wallet-section">
            <div id="wallet-status" class="status disconnected">Wallet Disconnected</div>
            <div id="wallet-details" style="display: none;">
                <div id="wallet-address" style="margin: 10px; font-family: monospace;"></div>
                <div id="wallet-balance" style="margin: 10px; font-size: 1.1rem;">Balance: 0.0000 ETH</div>
            </div>
            <button id="connect-btn" class="btn" onclick="connectWallet()">🔗 Connect Wallet</button>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('surveys')">📋 Surveys</button>
            <button class="nav-btn" onclick="showSection('create')">➕ Create Survey</button>
        </div>

        <div id="surveys-section" class="section">
            <h2>📋 Employee Satisfaction Surveys</h2>
            <div id="surveys-list"></div>
            <div id="no-surveys" class="empty-state">
                <h3>🌱 No Surveys Available</h3>
                <p>Create your first employee satisfaction survey!</p>
                <button class="btn" onclick="showSection('create')">➕ Create First Survey</button>
            </div>
        </div>

        <div id="create-section" class="section hidden">
            <h2>✨ Create Employee Satisfaction Survey</h2>
            <form id="create-form" onsubmit="createSurvey(event)">
                <div class="form-group">
                    <label class="form-label">📝 Survey Title</label>
                    <input type="text" id="survey-title" class="form-control" placeholder="Enter survey title..." required maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">📄 Survey Description</label>
                    <textarea id="survey-description" class="form-control" rows="4" placeholder="Describe the purpose and content of this survey..." required maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">⏰ Survey Duration (Days)</label>
                    <input type="number" id="survey-duration" class="form-control" min="1" max="30" value="14" placeholder="Set survey duration (1-30 days)" required>
                </div>
                <div class="form-group">
                    <label class="form-label">📋 Survey Questions</label>
                    <div id="survey-questions">
                        <input type="text" class="form-control" placeholder="Question 1" value="How satisfied are you with the overall work environment?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 2" value="How satisfied are you with your direct supervisor's management style?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 3" value="How satisfied are you with the compensation and benefits?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 4" value="How satisfied are you with career development opportunities?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 5" value="How satisfied are you with team collaboration atmosphere?" style="margin-bottom: 10px;">
                    </div>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                        💡 Rating Scale: 1-5 (1=Very Dissatisfied, 2=Dissatisfied, 3=Neutral, 4=Satisfied, 5=Very Satisfied)
                    </p>
                </div>
                <button type="submit" class="btn" style="font-size: 1.1rem; padding: 15px 30px;">📋 Create Survey</button>
            </form>
        </div>
    </div>

    <div id="alerts" class="alerts"></div>

    <script>
        let account = null;
        let balance = '0.0000';
        let surveys = JSON.parse(localStorage.getItem('employeeSurvey_surveys') || '[]');
        let surveyStates = new Map(); // 关键：防止按钮卡死
        let surveyTimeouts = new Map(); // 超时管理
        let userResponses = JSON.parse(localStorage.getItem('employeeSurvey_responses') || '{}');
        
        // 合约配置 - Sepolia 测试网
        const CONTRACT_ADDRESS = '0x32db9e03494b45a0b2b2B85Cfb767CD65B49275A';
        const SEPOLIA_CHAIN_ID = '0xaa36a7'; // 11155111 in hex
        const SEPOLIA_RPC = 'https://sepolia.infura.io/v3/';
        
        // 合约ABI - Employee Survey FHE Contract (Zama FHEVM)
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "string", "name": "_title", "type": "string"}, 
                          {"internalType": "string", "name": "_description", "type": "string"}, 
                          {"internalType": "string[]", "name": "_questions", "type": "string[]"}, 
                          {"internalType": "uint256", "name": "_durationDays", "type": "uint256"}],
                "name": "createSurvey",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "uint8[]", "name": "_ratings", "type": "uint8[]"}],
                "name": "submitResponse",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getSurvey",
                "outputs": [{"internalType": "address", "name": "creator", "type": "address"}, 
                           {"internalType": "string", "name": "title", "type": "string"}, 
                           {"internalType": "string", "name": "description", "type": "string"}, 
                           {"internalType": "uint256", "name": "startTime", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "endTime", "type": "uint256"}, 
                           {"internalType": "bool", "name": "active", "type": "bool"}, 
                           {"internalType": "bool", "name": "resultsPublished", "type": "bool"}, 
                           {"internalType": "uint256", "name": "totalResponses", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getSurveyQuestions",
                "outputs": [{"internalType": "string[]", "name": "", "type": "string[]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalSurveys",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "address", "name": "_employee", "type": "address"}],
                "name": "hasResponded",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "closeSurvey",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "publishResults",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "uint256", "name": "_questionId", "type": "uint256"}],
                "name": "requestQuestionResult",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getCurrentSurveyInfo",
                "outputs": [{"internalType": "bool", "name": "active", "type": "bool"}, 
                           {"internalType": "bool", "name": "resultsPublished", "type": "bool"}, 
                           {"internalType": "uint256", "name": "totalResponses", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "questionsCount", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "timeRemaining", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "address", "name": "_employee", "type": "address"}],
                "name": "getEmployeeResponseStatus",
                "outputs": [{"internalType": "bool", "name": "hasResponded", "type": "bool"}, 
                           {"internalType": "uint256", "name": "responseTime", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "address", "name": "creator", "type": "address"}, 
                          {"indexed": false, "internalType": "string", "name": "title", "type": "string"}, 
                          {"indexed": false, "internalType": "uint256", "name": "endTime", "type": "uint256"}],
                "name": "SurveyCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "address", "name": "respondent", "type": "address"}, 
                          {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}],
                "name": "ResponseSubmitted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": false, "internalType": "uint256", "name": "totalResponses", "type": "uint256"}],
                "name": "ResultsPublished",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "uint256", "name": "questionId", "type": "uint256"}, 
                          {"indexed": false, "internalType": "uint8", "name": "averageRating", "type": "uint8"}],
                "name": "ResultsRevealed",
                "type": "event"
            }
        ];
        
        let web3 = null;
        let contract = null;

        // 屏蔽常见的浏览器扩展警告
        window.addEventListener('error', (e) => {
            if (e.message && e.message.includes('runtime.lastError')) {
                e.preventDefault();
                return false;
            }
        });

        // 屏蔽控制台中的扩展相关警告
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('runtime.lastError') || 
                message.includes('devtools') ||
                message.includes('Extension context invalidated')) {
                return; // 静默这些警告
            }
            originalConsoleError.apply(console, args);
        };

        // 预设调查数据
        function initializePresetSurveys() {
            if (surveys.length === 0) {
                const presetSurveys = [
                    {
                        id: 1,
                        title: "Q1 2025 Employee Satisfaction Survey",
                        description: "Quarterly assessment of employee satisfaction across all departments focusing on work environment, management, and career development opportunities.",
                        questions: [
                            "How satisfied are you with the overall work environment?",
                            "How satisfied are you with your direct supervisor's management style?",
                            "How satisfied are you with the compensation and benefits package?",
                            "How satisfied are you with career development opportunities?",
                            "How satisfied are you with work-life balance?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-01-15'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with the overall work environment?", ratings: [2,5,15,25,8], totalResponses: 55, averageRating: 3.7 },
                            { question: "How satisfied are you with your direct supervisor's management style?", ratings: [3,4,12,28,8], totalResponses: 55, averageRating: 3.8 },
                            { question: "How satisfied are you with the compensation and benefits package?", ratings: [8,12,20,12,3], totalResponses: 55, averageRating: 2.9 },
                            { question: "How satisfied are you with career development opportunities?", ratings: [5,8,18,18,6], totalResponses: 55, averageRating: 3.4 },
                            { question: "How satisfied are you with work-life balance?", ratings: [1,3,10,30,11], totalResponses: 55, averageRating: 4.0 }
                        ],
                        totalResponses: 55,
                        status: 'active'
                    },
                    {
                        id: 2,
                        title: "Remote Work Experience Survey",
                        description: "Evaluate employee experience with remote work policies, tools, and collaboration effectiveness in distributed teams.",
                        questions: [
                            "How satisfied are you with remote work tools and technology?",
                            "How satisfied are you with communication and collaboration remotely?",
                            "How satisfied are you with remote work productivity levels?",
                            "How satisfied are you with manager support during remote work?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-02-01'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with remote work tools and technology?", ratings: [1,2,8,20,12], totalResponses: 43, averageRating: 3.9 },
                            { question: "How satisfied are you with communication and collaboration remotely?", ratings: [2,5,12,18,6], totalResponses: 43, averageRating: 3.5 },
                            { question: "How satisfied are you with remote work productivity levels?", ratings: [0,3,6,25,9], totalResponses: 43, averageRating: 3.9 },
                            { question: "How satisfied are you with manager support during remote work?", ratings: [1,4,10,22,6], totalResponses: 43, averageRating: 3.7 }
                        ],
                        totalResponses: 43,
                        status: 'active'
                    },
                    {
                        id: 3,
                        title: "Workplace Diversity & Inclusion Survey",
                        description: "Assessment of diversity, equity, and inclusion initiatives within the organization and their effectiveness in creating an inclusive workplace.",
                        questions: [
                            "How satisfied are you with diversity and inclusion efforts?",
                            "How satisfied are you with equal opportunities for advancement?",
                            "How satisfied are you with respect and fairness in the workplace?",
                            "How satisfied are you with leadership commitment to D&I?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-03-01'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with diversity and inclusion efforts?", ratings: [3,6,15,18,5], totalResponses: 47, averageRating: 3.4 },
                            { question: "How satisfied are you with equal opportunities for advancement?", ratings: [4,8,16,15,4], totalResponses: 47, averageRating: 3.1 },
                            { question: "How satisfied are you with respect and fairness in the workplace?", ratings: [2,4,12,22,7], totalResponses: 47, averageRating: 3.6 },
                            { question: "How satisfied are you with leadership commitment to D&I?", ratings: [5,7,14,16,5], totalResponses: 47, averageRating: 3.2 }
                        ],
                        totalResponses: 47,
                        status: 'active'
                    }
                ];
                
                surveys = presetSurveys;
                saveSurveys();
                console.log('📋 Preset surveys initialized:', surveys.length);
            }
        }

        // 清除旧数据并重新初始化
        function clearAndResetData() {
            console.log('🧹 Clearing old survey data...');
            localStorage.removeItem('employeeSurvey_surveys');
            localStorage.removeItem('employeeSurvey_responses');
            surveys = [];
            userResponses = {};
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Employee Survey System initializing...');
            
            // 清除旧数据以确保使用最新的预设数据
            clearAndResetData();
            
            initializePresetSurveys();
            renderSurveys();
            checkWalletConnection();
            showAlert('✨ Employee Survey System launched successfully', 'success', 3000);
        });

        // 检查钱包连接
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // 添加超时处理，避免长时间等待
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timeout')), 3000)
                    );
                    
                    const accountsPromise = window.ethereum.request({ method: 'eth_accounts' });
                    const accounts = await Promise.race([accountsPromise, timeout]);
                    
                    if (accounts.length > 0) {
                        account = accounts[0];
                        
                        // 初始化Web3和合约
                        await initializeWeb3();
                        
                        await updateBalance();
                        updateWalletDisplay();
                        renderSurveys();
                        showAlert('🎉 Wallet connected automatically', 'success', 3000);
                        console.log('✅ Wallet auto-connected:', account);
                    }
                } catch (error) {
                    // 只记录真正的错误，忽略扩展相关的警告
                    if (!error.message.includes('runtime.lastError') && 
                        !error.message.includes('Connection timeout')) {
                        console.error('Failed to check wallet connection:', error);
                    }
                }
            } else {
                console.log('💡 MetaMask not installed');
            }
        }

        // 连接钱包并切换到 Sepolia 网络
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showAlert('❌ Please install MetaMask wallet extension first', 'error');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            const btn = document.getElementById('connect-btn');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                console.log('🔗 Connecting wallet...');
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length > 0) {
                    account = accounts[0];
                    
                    // 检查并切换到 Sepolia 网络
                    await ensureSepoliaNetwork();
                    
                    // 初始化Web3和合约
                    await initializeWeb3();
                    
                    await updateBalance();
                    updateWalletDisplay();
                    renderSurveys();
                    showAlert('🎉 Wallet connected to Sepolia testnet!', 'success');
                    console.log('✅ Wallet connected successfully:', account);
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    showAlert('⚠️ User rejected wallet connection', 'warning');
                } else if (error.code === -32002) {
                    showAlert('⏳ Wallet connection request pending, please confirm in wallet', 'warning');
                } else {
                    showAlert('❌ Wallet connection failed', 'error');
                }
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // 确保连接到 Sepolia 网络
        async function ensureSepoliaNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    console.log('🔄 Switching to Sepolia network...');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                        showAlert('✅ Switched to Sepolia testnet', 'success');
                    } catch (switchError) {
                        // 如果网络不存在，添加 Sepolia 网络
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: SEPOLIA_CHAIN_ID,
                                    chainName: 'Sepolia Test Network',
                                    nativeCurrency: {
                                        name: 'Sepolia ETH',
                                        symbol: 'SEP ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://sepolia.infura.io/v3/', 'https://rpc.sepolia.org/'],
                                    blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                }]
                            });
                            showAlert('✅ Added and switched to Sepolia testnet', 'success');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    console.log('✅ Already on Sepolia network');
                }
            } catch (error) {
                console.error('Network switch failed:', error);
                showAlert('⚠️ Please manually switch to Sepolia testnet in MetaMask', 'warning');
                throw error;
            }
        }

        // 初始化Web3和合约
        async function initializeWeb3() {
            try {
                if (typeof window.ethereum !== 'undefined' && typeof Web3 !== 'undefined') {
                    web3 = new Web3(window.ethereum);
                    contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                    console.log('🔗 Web3 and contract initialized successfully');
                    console.log('📄 Contract address:', CONTRACT_ADDRESS);
                    
                    // 检查合约状态并更新UI
                    updateContractStatus();
                    
                    // 初始化区块链上的预设调查（如果已连接钱包）
                    if (account) {
                        await initializeBlockchainSurveys();
                    }
                    
                    return true;
                } else {
                    console.error('Web3 or Ethereum not available');
                    updateContractStatus(false, 'Web3 not available');
                    if (typeof Web3 === 'undefined') {
                        showAlert('⚠️ Web3 library not loaded. Please refresh the page.', 'warning');
                    }
                    return false;
                }
            } catch (error) {
                console.error('Failed to initialize Web3:', error);
                updateContractStatus(false, 'Web3 initialization failed');
                showAlert('⚠️ Failed to initialize blockchain connection', 'warning');
                return false;
            }
        }

        // 在区块链上创建预设调查（如果不存在的话）
        async function initializeBlockchainSurveys() {
            try {
                if (!account || !contract) return;
                
                console.log('🔍 Checking existing blockchain surveys...');
                
                // 获取区块链上的调查总数
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                console.log('📊 Total surveys on blockchain:', totalSurveys);
                
                // 如果区块链上没有调查，创建预设调查
                if (totalSurveys === '0') {
                    console.log('📝 Creating preset surveys on blockchain...');
                    showAlert('🔄 Initializing employee surveys on blockchain...', 'info');
                    
                    const presetSurveys = [
                        {
                            title: "Q1 2025 Employee Satisfaction Survey",
                            description: "Quarterly assessment of employee satisfaction across all departments focusing on work environment, management, and career development opportunities.",
                            questions: [
                                "How satisfied are you with the overall work environment?",
                                "How satisfied are you with your direct supervisor's management style?",
                                "How satisfied are you with the compensation and benefits package?",
                                "How satisfied are you with career development opportunities?",
                                "How satisfied are you with work-life balance?"
                            ],
                            duration: 365 // 1 year
                        },
                        {
                            title: "Remote Work Experience Survey",
                            description: "Evaluate employee experience with remote work policies, tools, and collaboration effectiveness in distributed teams.",
                            questions: [
                                "How satisfied are you with remote work tools and technology?",
                                "How satisfied are you with communication and collaboration remotely?",
                                "How satisfied are you with remote work productivity levels?",
                                "How satisfied are you with manager support during remote work?"
                            ],
                            duration: 365 // 1 year
                        },
                        {
                            title: "Workplace Diversity & Inclusion Survey",
                            description: "Assessment of diversity, equity, and inclusion initiatives within the organization and their effectiveness in creating an inclusive workplace.",
                            questions: [
                                "How satisfied are you with diversity and inclusion efforts?",
                                "How satisfied are you with equal opportunities for advancement?",
                                "How satisfied are you with respect and fairness in the workplace?",
                                "How satisfied are you with leadership commitment to D&I?"
                            ],
                            duration: 365 // 1 year
                        }
                    ];
                    
                    // 创建每个预设调查
                    for (let i = 0; i < presetSurveys.length; i++) {
                        const survey = presetSurveys[i];
                        try {
                            console.log(`📝 Creating survey ${i + 1}:`, survey.title);
                            
                            const gasEstimate = await contract.methods
                                .createSurvey(survey.title, survey.description, survey.questions, survey.duration)
                                .estimateGas({ from: account });
                                
                            const tx = await contract.methods
                                .createSurvey(survey.title, survey.description, survey.questions, survey.duration)
                                .send({ 
                                    from: account,
                                    gas: Math.floor(gasEstimate * 1.2),
                                    gasPrice: await web3.eth.getGasPrice()
                                });
                                
                            console.log(`✅ Survey ${i + 1} created:`, tx.transactionHash);
                            
                        } catch (error) {
                            console.error(`❌ Failed to create survey ${i + 1}:`, error);
                            // 如果创建失败，继续尝试下一个
                            continue;
                        }
                    }
                    
                    showAlert('✅ Employee surveys initialized on blockchain!', 'success');
                    
                    // 重新加载调查列表
                    await loadSurveysFromBlockchain();
                    
                } else {
                    console.log('✅ Surveys already exist on blockchain');
                    // 从区块链加载现有调查
                    await loadSurveysFromBlockchain();
                }
                
            } catch (error) {
                console.error('❌ Failed to initialize blockchain surveys:', error);
                showAlert('⚠️ Using preset surveys in local mode', 'warning');
            }
        }

        // 从区块链加载调查
        async function loadSurveysFromBlockchain() {
            try {
                if (!contract) return;
                
                console.log('📥 Loading surveys from blockchain...');
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                console.log('📊 Found', totalSurveys, 'surveys on blockchain');
                
                const blockchainSurveys = [];
                
                for (let i = 1; i <= totalSurveys; i++) {
                    try {
                        const surveyData = await contract.methods.getSurvey(i).call();
                        const questions = await contract.methods.getSurveyQuestions(i).call();
                        
                        const survey = {
                            id: i,
                            title: surveyData[1],
                            description: surveyData[2],
                            questions: questions,
                            creator: surveyData[0],
                            createdAt: new Date(surveyData[3] * 1000),
                            endTime: new Date(surveyData[4] * 1000),
                            status: surveyData[5] ? 'active' : 'inactive',
                            totalResponses: parseInt(surveyData[7]),
                            responses: questions.map(() => ({
                                ratings: [0,0,0,0,0],
                                totalResponses: 0,
                                averageRating: 0
                            }))
                        };
                        
                        blockchainSurveys.push(survey);
                        console.log(`📋 Loaded survey ${i}:`, survey.title);
                        
                    } catch (error) {
                        console.error(`❌ Failed to load survey ${i}:`, error);
                    }
                }
                
                if (blockchainSurveys.length > 0) {
                    surveys = blockchainSurveys;
                    saveSurveys();
                    renderSurveys();
                    console.log('✅ Surveys loaded from blockchain:', surveys.length);
                }
                
            } catch (error) {
                console.error('❌ Failed to load surveys from blockchain:', error);
            }
        }

        // 更新合约状态显示
        async function updateContractStatus(forceStatus = null, message = null) {
            const statusElement = document.getElementById('contract-status');
            
            if (!statusElement) return;
            
            // 检查FHE合约是否存在
            const contractExists = await checkContractExists();
            
            if (contractExists) {
                statusElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>FHE Contract Active - Encrypted Survey System</span>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: orange; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>Local Fallback Mode - Contract Not Detected</span>
                    </div>
                `;
            }
            return;
            
            if (forceStatus === false) {
                statusElement.innerHTML = '❌ Contract Unavailable - Local Mode';
                statusElement.style.background = 'rgba(239, 68, 68, 0.2)';
                statusElement.style.borderColor = '#ef4444';
                return;
            }
            
            if (!web3) {
                statusElement.innerHTML = '⏳ Waiting for wallet connection...';
                statusElement.style.background = 'rgba(251, 146, 60, 0.2)';
                return;
            }
            
            try {
                const contractExists = await checkContractExists();
                if (contractExists) {
                    statusElement.innerHTML = '✅ Contract Active - Blockchain Mode';
                    statusElement.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusElement.style.borderColor = '#10b981';
                } else {
                    statusElement.innerHTML = '⚠️ Contract Not Deployed - Local Mode';
                    statusElement.style.background = 'rgba(251, 146, 60, 0.2)';
                    statusElement.style.borderColor = '#f59e0b';
                }
            } catch (error) {
                statusElement.innerHTML = '❌ Contract Check Failed - Local Mode';
                statusElement.style.background = 'rgba(239, 68, 68, 0.2)';
                statusElement.style.borderColor = '#ef4444';
            }
        }

        // 断开钱包
        function disconnectWallet() {
            account = null;
            balance = '0.0000';
            updateWalletDisplay();
            renderSurveys();
            showAlert('👋 Wallet disconnected', 'info');
            console.log('🔌 Wallet disconnected');
        }

        // 更新余额
        async function updateBalance() {
            if (!account) return;
            
            try {
                const balanceWei = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [account, 'latest']
                });
                balance = (parseInt(balanceWei, 16) / Math.pow(10, 18)).toFixed(4);
                console.log('💰 Balance updated:', balance, 'ETH');
            } catch (error) {
                console.error('Failed to get balance:', error);
            }
        }

        // 更新钱包显示
        function updateWalletDisplay() {
            const status = document.getElementById('wallet-status');
            const details = document.getElementById('wallet-details');
            const btn = document.getElementById('connect-btn');

            if (account) {
                status.className = 'status connected';
                status.textContent = 'Wallet Connected';
                
                document.getElementById('wallet-address').textContent = 
                    `Address: ${account.substring(0, 8)}...${account.substring(34)}`;
                document.getElementById('wallet-balance').textContent = 
                    `Balance: ${balance} ETH`;
                
                details.style.display = 'block';
                btn.textContent = '🔓 Disconnect';
                btn.onclick = disconnectWallet;
            } else {
                status.className = 'status disconnected';
                status.textContent = 'Wallet Disconnected';
                details.style.display = 'none';
                btn.textContent = '🔗 Connect Wallet';
                btn.onclick = connectWallet;
            }
        }

        // 显示部分
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${section}-section`).classList.remove('hidden');
            event.target.classList.add('active');
            
            console.log('🔄 Switched to section:', section);
        }

        // 创建调查
        async function createSurvey(event) {
            event.preventDefault();
            
            if (!account) {
                showAlert('❌ Please connect wallet first', 'error');
                return;
            }

            const title = document.getElementById('survey-title').value.trim();
            const description = document.getElementById('survey-description').value.trim();
            const duration = parseInt(document.getElementById('survey-duration').value);
            
            // 获取调查问题
            const questionInputs = document.querySelectorAll('#survey-questions input');
            const questions = Array.from(questionInputs).map(input => input.value.trim()).filter(q => q);

            if (!title || !description || !duration || duration < 1 || questions.length < 1) {
                showAlert('❌ Please fill all required fields and provide at least 1 survey question', 'error');
                return;
            }

            try {
                console.log('📝 Creating survey on blockchain:', {title, description, duration, questions});
                
                // 验证合约连接
                if (!web3 || !contract) {
                    showAlert('📡 Initializing FHE contract connection...', 'info');
                    const initialized = await initializeWeb3();
                    if (!initialized) {
                        throw new Error('Failed to initialize Web3');
                    }
                }

                showAlert('🔄 Creating survey on FHE blockchain...', 'info');
                console.log('📊 Calling createSurvey on contract:', CONTRACT_ADDRESS);
                
                // 实际的区块链交易创建调查
                const gasEstimate = await contract.methods
                    .createSurvey(title, description, questions, duration)
                    .estimateGas({ from: account });
                    
                console.log('⛽ Estimated gas for survey creation:', gasEstimate);
                
                const tx = await contract.methods
                    .createSurvey(title, description, questions, duration)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2),
                        gasPrice: await web3.eth.getGasPrice()
                    });

                showAlert('⏳ Survey creation transaction sent! Waiting for confirmation...', 'info');
                console.log('📤 Survey creation transaction:', tx.transactionHash);
                
                // 等待交易确认
                let receipt;
                let attempts = 0;
                const maxAttempts = 30;
                
                while (attempts < maxAttempts) {
                    receipt = await web3.eth.getTransactionReceipt(tx.transactionHash);
                    if (receipt) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                    
                    if (attempts % 5 === 0) {
                        showAlert(`⏳ Still waiting for confirmation... (${attempts}s)`, 'info');
                    }
                }
                
                if (!receipt || !receipt.status) {
                    throw new Error('Survey creation transaction failed');
                }
                
                showAlert(`🎉 Survey Created on Blockchain! TX: ${tx.transactionHash.substring(0, 12)}...`, 'success');
                console.log('✅ Survey creation confirmed on blockchain:', tx.transactionHash);
                
                // 获取创建的调查ID
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                const surveyId = totalSurveys;
                
                console.log('📋 Survey ID from blockchain:', surveyId);
                
                // 创建本地副本用于UI显示
                const survey = {
                    id: parseInt(surveyId),
                    title,
                    description,
                    questions,
                    creator: account,
                    createdAt: new Date(),
                    endTime: new Date(Date.now() + duration * 24 * 60 * 60 * 1000),
                    responses: questions.map(question => ({
                        question, 
                        ratings: [0,0,0,0,0],
                        totalResponses: 0,
                        averageRating: 0
                    })),
                    totalResponses: 0,
                    status: 'active',
                    onChain: true,
                    txHash: tx.transactionHash,
                    blockNumber: receipt.blockNumber,
                    gasUsed: receipt.gasUsed
                };

                surveys.push(survey);
                saveSurveys();
                renderSurveys();
                
                document.getElementById('create-form').reset();
                showSection('surveys');
                
                console.log('✅ Survey created successfully on blockchain:', survey);

            } catch (error) {
                console.error('🚫 Blockchain survey creation failed:', error);
                
                let errorMessage = 'Failed to create survey on blockchain';
                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (error.code === -32000) {
                    errorMessage = 'Insufficient funds for gas';
                } else if (error.message?.includes('execution reverted')) {
                    errorMessage = 'Contract execution failed - check parameters';
                }
                
                showAlert(`❌ ${errorMessage}`, 'error');
                
                // 作为fallback创建本地调查
                console.log('📦 Creating local survey as fallback...');
                
                const localSurvey = {
                    id: Date.now(),
                    title,
                    description,
                    questions,
                    creator: account,
                    createdAt: new Date(),
                    endTime: new Date(Date.now() + duration * 24 * 60 * 60 * 1000),
                    responses: questions.map(question => ({
                        question, 
                        ratings: [0,0,0,0,0],
                        totalResponses: 0,
                        averageRating: 0
                    })),
                    totalResponses: 0,
                    status: 'active',
                    onChain: false
                };

                surveys.push(localSurvey);
                saveSurveys();
                renderSurveys();
                
                document.getElementById('create-form').reset();
                showAlert('📦 Created local survey as fallback', 'warning');
                showSection('surveys');
            }
        }

        // 检查合约是否在区块链上存在
        async function checkContractExists() {
            try {
                if (!web3) return false;
                
                const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                const exists = code && code !== '0x' && code !== '0x0';
                console.log('🔍 Contract exists:', exists, 'Code length:', code ? code.length : 0);
                return exists;
            } catch (error) {
                console.error('Failed to check contract existence:', error);
                return false;
            }
        }

        // 提交完整调查响应（区块链交易或本地存储）
        async function submitSurveyResponse(surveyId) {
            console.log('📊 Starting survey submission:', {surveyId});
            
            if (!account) {
                showAlert('❌ Please connect wallet first', 'error');
                return;
            }
            
            if (!web3 || !contract) {
                showAlert('📡 Initializing blockchain connection...', 'info');
                const initialized = await initializeWeb3();
                if (!initialized) {
                    showAlert('⚠️ Blockchain unavailable, using local storage mode', 'warning');
                    return await submitLocalResponse(surveyId);
                }
            }

            // 直接尝试FHE区块链交互
            console.log('🔗 Starting FHE survey submission process...');
            
            // 获取survey对象
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) {
                showAlert('❌ Survey not found', 'error');
                return;
            }
            
            try {
                // 收集所有问题的评分
                const answers = [];
                for (let i = 0; i < survey.questions.length; i++) {
                    const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                    if (!rating) {
                        showAlert(`❌ Please rate question ${i + 1} before submitting`, 'error');
                        return;
                    }
                    answers.push(parseInt(rating.value));
                }
                
                // 验证合约连接
                if (!web3 || !contract) {
                    showAlert('📡 Initializing FHE contract connection...', 'info');
                    const initialized = await initializeWeb3();
                    if (!initialized) {
                        throw new Error('Failed to initialize Web3');
                    }
                }
                
                // 提交到FHE合约 - 实际区块链交互
                showAlert('🔐 Encrypting and submitting survey responses...', 'info');
                console.log('📊 Submitting to FHE contract:', CONTRACT_ADDRESS);
                console.log('📝 Survey answers:', answers);
                
                // 实际的区块链交易
                const gasEstimate = await contract.methods
                    .submitResponse(surveyId, answers)
                    .estimateGas({ from: account });
                    
                console.log('⛽ Estimated gas:', gasEstimate);
                
                const tx = await contract.methods
                    .submitResponse(surveyId, answers)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2), // 增加20%gas buffer
                        gasPrice: await web3.eth.getGasPrice()
                    });
                
                showAlert('⏳ FHE transaction sent! Waiting for blockchain confirmation...', 'info');
                console.log('📤 Transaction sent:', tx.transactionHash);
                
                // 等待交易确认
                let receipt;
                let attempts = 0;
                const maxAttempts = 30; // 最多等待30秒
                
                while (attempts < maxAttempts) {
                    receipt = await web3.eth.getTransactionReceipt(tx.transactionHash);
                    if (receipt) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                    attempts++;
                    
                    if (attempts % 5 === 0) {
                        showAlert(`⏳ Still waiting for confirmation... (${attempts}s)`, 'info');
                    }
                }
                
                if (!receipt) {
                    throw new Error('Transaction confirmation timeout');
                }
                
                if (receipt.status) {
                    showAlert(`🎉 FHE Survey Successfully Submitted! TX: ${tx.transactionHash.substring(0, 12)}...`, 'success');
                    console.log('✅ FHE transaction confirmed:', tx.transactionHash);
                    console.log('📋 Gas used:', receipt.gasUsed);
                    
                    // 记录成功的区块链提交
                    const userKey = `${account}_${surveyId}`;
                    userResponses[userKey] = {
                        surveyId,
                        timestamp: new Date().toISOString(),
                        txHash: tx.transactionHash,
                        answers: answers,
                        method: 'fhe_blockchain',
                        gasUsed: receipt.gasUsed,
                        blockNumber: receipt.blockNumber
                    };
                    localStorage.setItem('employeeSurvey_responses', JSON.stringify(userResponses));
                    
                    // 更新UI状态
                    const submitBtn = surveyElement.querySelector('.submit-survey-btn');
                    if (submitBtn) {
                        submitBtn.innerHTML = '✅ Submitted to Blockchain';
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.6';
                    }
                    
                    return;
                } else {
                    throw new Error('Transaction failed - receipt status false');
                }
                
            } catch (error) {
                console.error('🚫 FHE submission failed:', error);
                
                let errorMessage = 'FHE contract interaction failed';
                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (error.code === -32000) {
                    errorMessage = 'Insufficient funds for gas';
                } else if (error.message?.includes('execution reverted')) {
                    errorMessage = 'Contract execution failed - check survey status';
                } else if (error.message?.includes('timeout')) {
                    errorMessage = 'Transaction timeout - may still be processing';
                }
                
                showAlert(`⚠️ ${errorMessage}. Using local mode.`, 'warning');
            }
            
            // 回退到本地存储模式
            showAlert('📦 Using local mode - Deploy EmployeePrivacyFHE.sol contract', 'info');
            return await submitLocalResponse(surveyId);

            // 检查是否已经参与过调查
            const userKey = `${account}_${surveyId}`;
            if (userResponses[userKey]) {
                showAlert('⚠️ You have already participated in this survey', 'warning');
                return;
            }

            // 收集所有问题的评分
            const answers = [];
            for (let i = 0; i < survey.questions.length; i++) {
                const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                if (!rating) {
                    showAlert(`❌ Please rate question ${i + 1} before submitting`, 'error');
                    return;
                }
                answers.push(parseInt(rating.value));
            }

            try {
                showAlert('📊 Submitting survey response to blockchain...', 'info');
                
                // 创建加密的答案数组（简化版，实际应使用FHE加密）
                const encryptedAnswers = answers.map(answer => {
                    // 模拟加密，实际应使用TFHE.encrypt()
                    return web3.utils.asciiToHex(answer.toString());
                });

                // 调用合约提交响应
                console.log('🔍 Estimating gas for transaction...');
                console.log('Contract method exists:', !!contract.methods.submitResponse);
                
                const gasEstimate = await contract.methods
                    .submitResponse(surveyId, encryptedAnswers)
                    .estimateGas({ from: account });
                
                console.log('⛽ Estimated gas:', gasEstimate);

                const tx = await contract.methods
                    .submitResponse(surveyId, encryptedAnswers)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2)
                    });
                
                console.log('✅ Transaction sent:', tx);

                console.log('✅ Transaction successful:', tx.transactionHash);

                // 更新本地数据
                for (let i = 0; i < answers.length; i++) {
                    survey.responses[i].ratings[answers[i] - 1]++;
                    survey.responses[i].totalResponses++;
                    
                    // 重新计算平均分
                    let totalScore = 0;
                    for (let j = 0; j < 5; j++) {
                        totalScore += survey.responses[i].ratings[j] * (j + 1);
                    }
                    survey.responses[i].averageRating = 
                        (totalScore / survey.responses[i].totalResponses).toFixed(1);
                }

                // 记录用户参与
                userResponses[userKey] = {
                    surveyId,
                    timestamp: new Date(),
                    txHash: tx.transactionHash,
                    answers: answers
                };

                saveSurveys();
                saveUserResponses();
                renderSurveys();
                
                showAlert(`🎉 Survey response submitted successfully! TX: ${tx.transactionHash.substring(0, 10)}...`, 'success');
                
                // 显示Etherscan链接
                setTimeout(() => {
                    showAlert(`🔍 View transaction: https://sepolia.etherscan.io/tx/${tx.transactionHash}`, 'info', 10000);
                }, 1000);

            } catch (error) {
                console.error('Survey submission failed:', error);
                let errorMsg = 'Survey submission failed';
                
                if (error.code === 4001) {
                    errorMsg = 'Transaction cancelled by user';
                } else if (error.message.includes('revert')) {
                    errorMsg = 'Contract rejected transaction - you may have already responded';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient ETH for gas fees';
                }
                
                showAlert(`❌ ${errorMsg}`, 'error');
            }
        }

        // 本地存储fallback模式（当合约不可用时）
        async function submitLocalResponse(surveyId) {
            console.log('💾 Submitting survey response locally:', {surveyId});
            
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) {
                showAlert('❌ Survey does not exist', 'error');
                return;
            }

            // 检查是否已经参与过调查
            const userKey = `${account}_${surveyId}`;
            if (userResponses[userKey]) {
                showAlert('⚠️ You have already participated in this survey', 'warning');
                return;
            }

            // 收集所有问题的评分
            const answers = [];
            for (let i = 0; i < survey.questions.length; i++) {
                const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                if (!rating) {
                    showAlert(`❌ Please rate question ${i + 1} before submitting`, 'error');
                    return;
                }
                answers.push(parseInt(rating.value));
            }

            try {
                showAlert('💾 Saving your responses locally...', 'info');
                
                // 模拟处理延迟
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 更新本地数据
                for (let i = 0; i < answers.length; i++) {
                    survey.responses[i].ratings[answers[i] - 1]++;
                    survey.responses[i].totalResponses++;
                    
                    // 重新计算平均分
                    let totalScore = 0;
                    for (let j = 0; j < 5; j++) {
                        totalScore += survey.responses[i].ratings[j] * (j + 1);
                    }
                    survey.responses[i].averageRating = 
                        (totalScore / survey.responses[i].totalResponses).toFixed(1);
                }

                // 记录用户参与（本地模式）
                userResponses[userKey] = {
                    surveyId,
                    timestamp: new Date(),
                    mode: 'local', // 标记为本地模式
                    answers: answers
                };

                saveSurveys();
                saveUserResponses();
                renderSurveys();
                
                showAlert('🎉 Survey response saved successfully! (Local Mode)', 'success');
                console.log('💾 Local response saved successfully');

            } catch (error) {
                console.error('Local survey submission failed:', error);
                showAlert('❌ Failed to save response locally', 'error');
            }
        }

        // 临时评分存储（在提交前）
        function selectRating(surveyId, questionIndex, rating) {
            console.log(`⭐ Selected rating ${rating} for question ${questionIndex + 1} in survey ${surveyId}`);
            
            // 更新UI显示
            const allBtns = document.querySelectorAll(`.rating-btn[data-survey="${surveyId}"][data-question="${questionIndex}"]`);
            allBtns.forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.borderColor = 'rgba(255,255,255,0.3)';
                btn.style.transform = 'none';
                btn.style.boxShadow = 'none';
            });
            
            const selectedBtn = document.querySelector(`.rating-btn[data-survey="${surveyId}"][data-question="${questionIndex}"][data-rating="${rating}"]`);
            if (selectedBtn) {
                selectedBtn.style.background = 'linear-gradient(45deg, #10b981, #34d399)';
                selectedBtn.style.borderColor = '#34d399';
                selectedBtn.style.transform = 'translateY(-2px)';
                selectedBtn.style.boxShadow = '0 5px 15px rgba(16, 185, 129, 0.4)';
            }
            
            // 确保radio button被选中
            const radioBtn = document.getElementById(`rate-${surveyId}-${questionIndex}-${rating}`);
            if (radioBtn) {
                radioBtn.checked = true;
            }
        }

        // 检查调查状态
        function checkSurveyStatus(survey) {
            const now = new Date();
            const endTime = new Date(survey.endTime);
            
            if (now > endTime && survey.status === 'active') {
                survey.status = 'ended';
                return 'ended';
            }
            return survey.status;
        }

        // 渲染调查
        function renderSurveys() {
            const surveysList = document.getElementById('surveys-list');
            const noSurveys = document.getElementById('no-surveys');

            if (surveys.length === 0) {
                surveysList.innerHTML = '';
                noSurveys.style.display = 'block';
                return;
            }

            noSurveys.style.display = 'none';
            
            surveysList.innerHTML = surveys.map(survey => {
                const status = checkSurveyStatus(survey);
                const isActive = status === 'active';
                const isCreator = survey.creator === account;
                const userKey = `${account}_${survey.id}`;
                const hasParticipated = userResponses[userKey];
                const canParticipate = account && !isCreator && isActive && !hasParticipated;
                
                // 调试信息
                console.log(`Survey ${survey.id} - Can participate:`, {
                    hasAccount: !!account,
                    isNotCreator: !isCreator,
                    isActive: isActive,
                    hasNotParticipated: !hasParticipated,
                    canParticipate: canParticipate
                });
                
                const endTime = new Date(survey.endTime);
                const timeLeft = endTime - new Date();
                const daysLeft = Math.max(0, Math.ceil(timeLeft / (24 * 60 * 60 * 1000)));
                
                return `
                    <div class="project-card">
                        <div class="project-title">${escapeHtml(survey.title)}</div>
                        <div class="project-description">${escapeHtml(survey.description)}</div>
                        
                        <div class="project-stats">
                            <span><strong>Status: ${isActive ? '🟢 Active' : '🔴 Ended'}</strong></span>
                            <span>Questions: ${survey.questions.length}</span>
                            <span>${isActive ? `Remaining: ${daysLeft} days` : 'Ended'}</span>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            ${survey.responses.map((response, index) => {
                                const avgRating = response.averageRating || 0;
                                const totalResponses = response.totalResponses || 0;
                                
                                return `
                                    <div class="survey-section" style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>Q${index + 1}: ${escapeHtml(response.question)}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Average Rating: ⭐ ${avgRating}/5.0</span>
                                            <span>Responses: ${totalResponses}</span>
                                        </div>
                                        ${canParticipate ? `
                                            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                                                ${[1,2,3,4,5].map(rating => `
                                                    <label style="cursor: pointer; display: flex; flex-direction: column; align-items: center;">
                                                        <input type="radio" 
                                                               id="rate-${survey.id}-${index}-${rating}"
                                                               name="survey-${survey.id}-question-${index}" 
                                                               value="${rating}"
                                                               style="display: none;">
                                                        <span class="rating-btn" 
                                                              data-survey="${survey.id}"
                                                              data-question="${index}"
                                                              data-rating="${rating}"
                                                              style="
                                                                padding: 8px 12px; 
                                                                border: 2px solid rgba(255,255,255,0.3); 
                                                                border-radius: 10px; 
                                                                background: rgba(255,255,255,0.1);
                                                                transition: all 0.3s;
                                                                min-width: 40px;
                                                                text-align: center;
                                                                cursor: pointer;
                                                              " onclick="selectRating(${survey.id}, ${index}, ${rating});">
                                                            ${rating}⭐
                                                        </span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${canParticipate ? `
                            <div style="background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1)); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid rgba(16, 185, 129, 0.3);">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <h3 style="color: #34d399; margin-bottom: 10px;">👆 Rate Each Question Above</h3>
                                    <p style="font-size: 0.9rem; opacity: 0.8;">
                                        Click on the ⭐ buttons (1-5 stars) to rate each question, then submit your response
                                    </p>
                                </div>
                                <div style="text-align: center;">
                                    <button class="btn" 
                                            style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(45deg, #10b981, #34d399);"
                                            onclick="submitSurveyResponse(${survey.id})">
                                        📊 Submit Survey Response
                                    </button>
                                    <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 8px;">
                                        🔐 Will attempt blockchain submission, fallback to local storage if needed
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">
                            Creator: ${survey.creator.substring(0, 8)}...${survey.creator.substring(34)}<br>
                            Created: ${new Date(survey.createdAt).toLocaleDateString('en-US')}<br>
                            Deadline: ${endTime.toLocaleDateString('en-US')} ${endTime.toLocaleTimeString('en-US')}
                        </div>
                        
                        ${isCreator ? '<div class="owner-badge">👑 Your Survey</div>' : ''}
                        
                        ${hasParticipated ? `
                            <div class="completed-badge">
                                ✅ Participated 
                                ${hasParticipated.txHash ? 
                                    `- <a href="https://sepolia.etherscan.io/tx/${hasParticipated.txHash}" target="_blank" style="color: white;">TX: ${hasParticipated.txHash.substring(0, 10)}...</a>` : 
                                    hasParticipated.mode === 'local' ? '- Local Mode' : ''
                                }
                            </div>` : ''}
                        
                        ${!account ? 
                            '<div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">Please connect wallet to participate in survey</div>' 
                            : ''
                        }
                    </div>
                `;
            }).join('');
            
            console.log('📊 Surveys list rendered:', surveys.length, 'surveys');
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示提示消息
        function showAlert(message, type = 'success', duration = 5000) {
            console.log('💬 显示消息:', type, message);
            
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            alert.innerHTML = `${icons[type] || 'ℹ️'} ${message}`;
            
            alerts.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                }
            }, duration);
        }

        // 保存调查到本地存储
        function saveSurveys() {
            try {
                localStorage.setItem('employeeSurvey_surveys', JSON.stringify(surveys));
                console.log('💾 Survey data saved');
            } catch (error) {
                console.error('Failed to save surveys:', error);
                showAlert('⚠️ Failed to save data', 'warning');
            }
        }
        
        // 保存用户响应到本地存储
        function saveUserResponses() {
            try {
                localStorage.setItem('employeeSurvey_responses', JSON.stringify(userResponses));
                console.log('💾 User response data saved');
            } catch (error) {
                console.error('Failed to save user responses:', error);
                showAlert('⚠️ Failed to save data', 'warning');
            }
        }

        // 监听钱包事件
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('🔄 Account changed:', accounts);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (accounts[0] !== account) {
                    account = accounts[0];
                    initializeWeb3().then(() => {
                        updateBalance().then(() => {
                            updateWalletDisplay();
                            renderSurveys();
                            showAlert('🔄 Account switched', 'info');
                        });
                    });
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('🔄 Network changed to:', chainId);
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    showAlert('⚠️ Please switch back to Sepolia testnet', 'warning');
                } else {
                    showAlert('✅ Connected to Sepolia testnet', 'success');
                }
                initializeWeb3().then(() => {
                    updateBalance().then(() => {
                        updateWalletDisplay();
                        renderSurveys();
                    });
                });
            });
        }

        // 页面卸载前清理
        window.addEventListener('beforeunload', () => {
            // 清理所有超时器
            surveyTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
            surveyTimeouts.clear();
            surveyStates.clear();
            console.log('🧹 Application cleanup completed');
        });
    </script>
</body>
</html>